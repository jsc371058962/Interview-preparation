# React diff和虚拟DOM

## 虚拟DOM

### 1. 定义: js对象到真实DOM的一种映射与抽象,通常包含3个属性

- 1.1. `tag`: 代表真实dom的`tagName`
- 1.2. `attrs/props`: 指元素节点的各种属性值
- 1.3. `children`: 表示此元素的子节点,一般会以数组的形式展现

### 2. 工作原理

- 2.1. 初始化时会生成一棵`虚拟dom`树,将其保存在内存中
- 2.2. 当数据(`props/state`)更新变化时,会自动更新并生成一棵新的`虚拟dom`树
- 2.3. 通过diff算法,比较新旧两个`虚拟dom`树,得出最小有变化的部分,将这个变化的部分(`patch`)推入队列
- 2.4. 在事件循环的末尾将这些`patch`批量更新到真实dom的过程

## diff

### 1. 传统diff

- 1.1. 时间复杂度: `O(n^3)`
- 1.2. 复杂度太高,`1000`个节点需要进行`10亿`次的节点比较,显然无法满足高性能应用的要求

### 2. React diff

- 2.1 假设
  - 2.1.1. 两个不同类型的元素会产生不同的树
  - 2.1.2. 开发者通过设置唯一的`key`值,告诉React哪些节点是可与被保留不被删除的
- 2.2. 3个策略
  通过以上2个假设,React针对性的提出了3个优化策略
  - 2.2.1 Web UI中的dom跨层级移动操作很少,可以忽略不计
  - 2.2.2 拥有相同类型的两个组件会生成相似的树形结构,拥有不同类型的两个组件会生成不同的树形结构
  - 2.2.3 对于同一层级的一组子节点,通过`key`对其加以区分
- 2.3. diff具体优化
  基于以上3个策略,React对以下三个部分进行了diff算法优化
  - 2.3.1 tree diff
    - **分层比较**: React只会对`虚拟DOM`进行分层比较,不考虑节点跨层级的比较.通过`updateDepth`对`虚拟DOM`树进行层级控制,通过比较结果,进行节点的新增和删除,如此只需要遍历一次`虚拟DOM`树,就能完成整个树的对比
    - **跨层级操作**: React**并不会对复用**已有节点,而是对其进行删除并重建,因此可能会产生大量的重新创建操作,影响性能,React官方推荐尽量避免跨层级的操作
  - 2.3.2 component diff
    - **相同类型**: 在比较相同类型的组件时,React通过开发人员自定义的`shouldComponentUpdate`()生命周期函数来进行比较优化,减少组件不必要的比较.如果未定义,则默认返回`true`,默认每次组件发生数据(`props/state`)变化时都会进行比较.(使用`PureComponent`时,其会自动维护一个`shouldComponentUpdate`()进行浅层比较)
    - **不同类型**: 对于不同类型的组件,默认不会进行比较操作,直接冲进创建
  - 2.3.3 element diff
    element diff 涉及三种操作：移动、创建、删除
    element diff使用唯一的`key`值来进行`diff`优化,通过复用已知节点,减少节点的删除和创建
    - **不使用key**: React通过同时遍历此新旧两个相同层级的一组子节点,使得节点不能复用,频繁的进行删除和创建操作,影响性能
    - **使用唯一的key**: React首先会对新的集合进行遍历,通过唯一`key`来判断老集合中是否存在相同的节点,如果没有则创建,如果有则判断是否需要进行移动操作(React对于移动操作也采用了比较高效的算法,使用了一种顺序优化手段)
